<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="icon" type="image/png" href="images/losp.png">
    <link rel="stylesheet" href="css/admin_ui.css">
</head>
<body>
    <div class="bg-fixed"></div>

    <div class="container">
        <header>
            <img src="images/lph.png" alt="Logo" class="logo">
            <div class="text">
                <h1>Admin Dashboard</h1>
                <p class="subtitle">Manage Job Applications and General Inquiries</p>
            </div>
            <div class="user-info">
                <span class="welcome-text">Welcome, <?php echo htmlspecialchars($_SESSION['admin_username']); ?></span>
                <a href="php/logout.php" class="logout-btn">Logout</a>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('applications')">
                Job Applications <span id="app-counter" class="counter">0</span>
            </button>
            <button class="tab-btn" onclick="showTab('inquiries')">
                General Inquiries <span id="inq-counter" class="counter">0</span>
            </button>
        </div>

        <!-- Job Applications Section -->
        <section id="applications" class="tab-content active">
            <div class="section-header">
                <h2>Job Applications <span id="app-counter-header" class="counter">0</span></h2>
                <div class="header-controls">
                    <div class="filter-container">
                        <label for="job-filter">Filter by Job:</label>
                        <select id="job-filter" onchange="filterApplications()">
                            <option value="all">All Jobs</option>
                        </select>
                    </div>
                    <button onclick="refreshData('applications')" class="refresh-btn">Refresh</button>
                </div>
            </div>
            <div id="applications-content" class="data-container">
                <!-- Data will be loaded here via PHP -->
            </div>
        </section>

        <!-- General Inquiries Section -->
        <section id="inquiries" class="tab-content">
            <div class="section-header">
                <h2>General Inquiries <span id="inq-counter-header" class="counter">0</span></h2>
                <button onclick="refreshData('inquiries')" class="refresh-btn">Refresh</button>
            </div>
            <div id="inquiries-content" class="data-container">
                <!-- Data will be loaded here via PHP -->
            </div>
        </section>
    </div>

    <!-- Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p id="modal-message">Are you sure you want to delete this item?</p>
            <div class="modal-buttons">
                <button onclick="confirmDelete()" class="btn-confirm">Delete</button>
                <button onclick="closeModal()" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let deleteType = '';
        let deleteId = '';
        let allApplications = [];
        let currentFilter = 'all';

        // Load data when page loads
        window.onload = function() {
            loadApplications();
            loadInquiries();
        };

        // Tab switching function
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Load job applications
        function loadApplications() {
            fetch('php/fetch_applications.php')
                .then(response => response.json())
                .then(data => {
                    allApplications = data.applications || [];
                    updateJobFilter();
                    displayApplications();
                    updateCounter('app', data.count);
                })
                .catch(error => {
                    document.getElementById('applications-content').innerHTML = 
                        '<p class="error">Error loading applications: ' + error + '</p>';
                });
        }

        // Update job filter dropdown
        function updateJobFilter() {
            const filterSelect = document.getElementById('job-filter');
            const jobTitles = [...new Set(allApplications.map(app => app.job_title))].sort();
            
            // Clear existing options except "All Jobs"
            filterSelect.innerHTML = '<option value="all">All Jobs</option>';
            
            // Add job titles as options
            jobTitles.forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                option.textContent = title;
                filterSelect.appendChild(option);
            });
            
            // Restore previous filter if it still exists
            if (currentFilter !== 'all' && jobTitles.includes(currentFilter)) {
                filterSelect.value = currentFilter;
            } else {
                currentFilter = 'all';
            }
        }

        // Filter applications by job title
        function filterApplications() {
            currentFilter = document.getElementById('job-filter').value;
            displayApplications();
        }

        // Display applications based on current filter
        function displayApplications() {
            const container = document.getElementById('applications-content');
            let filteredApps = allApplications;
            
            if (currentFilter !== 'all') {
                filteredApps = allApplications.filter(app => app.job_title === currentFilter);
            }
            
            if (filteredApps.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Applications Found</h3>
                        <p>${currentFilter === 'all' ? 'There are no job applications to display at this time.' : 'No applications found for this job position.'}</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredApps.forEach(row => {
                html += '<div class="card">';
                html += '<div class="card-header">';
                html += '<div class="card-title">' + escapeHtml(row.job_title) + '</div>';
                html += '<div class="card-date">' + formatDate(row.created_at) + '</div>';
                html += '</div>';
                
                html += '<div class="card-info">';
                html += '<span class="card-label">Name:</span> ';
                html += '<span class="card-value">' + escapeHtml(row.applicant_name) + '</span>';
                html += '</div>';
                
                html += '<div class="card-info">';
                html += '<span class="card-label">Email:</span> ';
                html += '<span class="card-value">' + escapeHtml(row.applicant_email) + '</span>';
                html += '</div>';
                
                html += '<div class="card-message">';
                html += '<div class="card-message-label">Application Pitch:</div>';
                html += '<div class="card-message-text">' + escapeHtml(row.application_pitch).replace(/\n/g, '<br>') + '</div>';
                html += '</div>';
                
                html += '<button class="delete-btn" onclick="showDeleteModal(\'application\', \'' + row.id + '\', \'' + escapeHtml(row.applicant_name).replace(/'/g, "\\'") + '\')">Delete Application</button>';
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }

        // Load general inquiries
        function loadInquiries() {
            fetch('php/fetch_inquiries.php')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('inquiries-content').innerHTML = data.html;
                    updateCounter('inq', data.count);
                })
                .catch(error => {
                    document.getElementById('inquiries-content').innerHTML = 
                        '<p class="error">Error loading inquiries: ' + error + '</p>';
                });
        }

        // Update counter displays
        function updateCounter(type, count) {
            if (type === 'app') {
                document.getElementById('app-counter').textContent = count;
                document.getElementById('app-counter-header').textContent =  count;
            } else {
                document.getElementById('inq-counter').textContent = count;
                document.getElementById('inq-counter-header').textContent =  count;
            }
        }

        // Refresh data
        function refreshData(type) {
            if (type === 'applications') {
                loadApplications();
            } else {
                loadInquiries();
            }
        }

        // Show delete confirmation modal
        function showDeleteModal(type, id, name) {
            deleteType = type;
            deleteId = id;
            
            const itemType = type === 'application' ? 'job application' : 'inquiry';
            document.getElementById('modal-message').textContent = 
                `Are you sure you want to delete this ${itemType} from "${name}"?`;
            
            document.getElementById('deleteModal').style.display = 'block';
        }

        // Close modal
        function closeModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteType = '';
            deleteId = '';
        }

        // Confirm and execute delete
        function confirmDelete() {
            fetch('php/delete_item.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `type=${deleteType}&id=${deleteId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload the appropriate section
                    if (deleteType === 'application') {
                        loadApplications();
                    } else {
                        loadInquiries();
                    }
                    closeModal();
                } else {
                    alert('Error deleting item: ' + data.message);
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            };
            return date.toLocaleString('en-US', options);
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>